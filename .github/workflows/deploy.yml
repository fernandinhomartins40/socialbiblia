name: ğŸš€ Deploy Biblicai to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '31.97.85.98'
  VPS_USER: 'root'
  APP_DIR: '/opt/biblicai'
  COMPOSE_PROJECT_NAME: 'biblicai'

jobs:
  # ====================================
  # JOB 1: VALIDAÃ‡ÃƒO E BUILD LOCAL
  # ====================================
  validate-and-build:
    name: ğŸ” Validate & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            apps/backend/package-lock.json
            apps/web/package-lock.json

      - name: ğŸ” Verify project structure
        run: |
          echo "ğŸ” Verificando estrutura do projeto..."
          
          # Arquivos obrigatÃ³rios para o novo setup
          REQUIRED_FILES=(
            "docker-compose.new.yml"
            "apps/backend/package.json"
            "apps/backend/tsconfig.json"
            "apps/backend/prisma/schema.prisma"
            "apps/backend/.env.ci"
            "apps/backend/src/server/app.ts"
            "apps/web/package.json"
            "apps/web/vite.config.ts"
            "configs/docker/Dockerfile.backend"
            "configs/docker/Dockerfile.web"
            "configs/docker/nginx.conf"
            "configs/docker/default.conf"
            ".env.production"
            "scripts/deploy-vps.sh"
            "scripts/deploy-production.sh"
            "turbo.json"
            "tsconfig.base.json"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found: $file"
            else
              echo "âŒ Missing: $file"
              exit 1
            fi
          done
          
          echo "âœ… Estrutura do projeto validada"

      - name: ğŸ—ï¸ Install All Dependencies (Monorepo)
        run: |
          echo "ğŸ“¦ Instalando dependÃªncias do monorepo e workspaces..."
          npm install --frozen-lockfile --ignore-scripts --no-fund --no-audit
          echo "âœ… DependÃªncias do monorepo e workspaces instaladas"

      - name: ğŸ”§ Setup CI Environment
        run: |
          echo "ğŸ”§ Configurando ambiente CI..."
          cd apps/backend
          cp .env.ci .env
          echo "âœ… Arquivo de ambiente CI configurado"

      - name: ğŸ”§ Generate Prisma Client
        run: |
          echo "ğŸ—ƒï¸ Gerando cliente Prisma..."
          cd apps/backend
          npx prisma generate
          echo "âœ… Cliente Prisma gerado"
          
      - name: ğŸ” Validate Prisma Schema
        run: |
          echo "ğŸ” Validando schema do Prisma..."
          cd apps/backend
          npx prisma validate
          echo "âœ… Schema do Prisma validado"

      - name: ğŸ—ï¸ Build Backend
        run: |
          echo "ğŸ”¨ Fazendo build do backend..."
          npm run build:backend
          echo "âœ… Build do backend concluÃ­do"

      - name: ğŸ—ï¸ Build Frontend
        run: |
          echo "ğŸ”¨ Fazendo build do frontend..."
          npm run build:web
          echo "âœ… Build do frontend concluÃ­do"

      - name: ğŸ§ª Validate TypeScript (Backend)
        run: |
          echo "ğŸ” Validando TypeScript do backend..."
          cd apps/backend
          npx tsc --noEmit
          echo "âœ… TypeScript do backend validado"
          
      - name: ğŸ” Validate API Structure
        run: |
          echo "ğŸ” Validando estrutura da API..."
          cd apps/backend
          
          # Verificar arquivos crÃ­ticos das novas implementaÃ§Ãµes
          CRITICAL_FILES=(
            "src/controllers/client/posts_controller.ts"
            "src/controllers/client/comments_controller.ts"
            "src/services/client/posts/index.ts"
            "src/services/client/comments/index.ts"
            "src/routes/client/v1/posts_route.ts"
            "src/routes/client/v1/comments_route.ts"
            "src/dao/posts/post_delete_dao.ts"
            "src/dao/comments/comment_create_dao.ts"
            "src/dao/comments/comment_get_all_dao.ts"
            "prisma/migrations/20250724100141_initial_sqlite/migration.sql"
          )
          
          echo "Verificando arquivos crÃ­ticos das implementaÃ§Ãµes..."
          for file in "${CRITICAL_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found: $file"
            else
              echo "âŒ Missing critical file: $file"
              exit 1
            fi
          done
          
          echo "âœ… Estrutura da API validada"

      - name: ğŸ§ª Validate TypeScript (Frontend)
        run: |
          echo "ğŸ” Validando TypeScript do frontend..."
          cd apps/web
          npm run typecheck
          echo "âœ… TypeScript do frontend validado"

  # ====================================
  # JOB 2: DEPLOY NA VPS
  # ====================================
  deploy:
    name: ğŸš€ Deploy to VPS
    runs-on: ubuntu-latest
    needs: validate-and-build
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          timeout: 900s
          command_timeout: 900s
          script: |
            # Download and execute the production deploy script
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/deploy-production.sh -o /tmp/deploy-production.sh
            chmod +x /tmp/deploy-production.sh
            /tmp/deploy-production.sh "${{ env.VPS_HOST }}" "${{ env.APP_DIR }}" "https://github.com/${{ github.repository }}.git"

  # ====================================
  # JOB 3: NOTIFICAÃ‡ÃƒO (OPCIONAL)
  # ====================================
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: ğŸ“¢ Deploy Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deploy realizado com sucesso!"
            echo "ğŸŒ Biblicai disponÃ­vel em: http://${{ env.VPS_HOST }}:3000"
          else
            echo "âŒ Deploy falhou!"
            exit 1
          fi