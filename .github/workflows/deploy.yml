name: üöÄ Deploy Social B√≠blia to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '31.97.85.98'
  VPS_USER: 'root'
  APP_DIR: '/opt/socialbiblia'
  COMPOSE_PROJECT_NAME: 'socialbiblia'

jobs:
  # ====================================
  # JOB 1: VALIDA√á√ÉO E BUILD LOCAL
  # ====================================
  validate-and-build:
    name: üîç Validate & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üèóÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            apps/backend/package-lock.json

      - name: üîç Verify project structure
        run: |
          echo "üîç Verificando estrutura do projeto..."
          
          # Arquivos obrigat√≥rios para o novo setup
          REQUIRED_FILES=(
            "docker-compose.new.yml"
            "apps/backend/package.json"
            "apps/backend/tsconfig.json"
            "apps/backend/prisma/schema.prisma"
            "apps/backend/src/app.ts"
            "apps/web/package.json"
            "apps/web/vite.config.ts"
            "configs/docker/Dockerfile.backend"
            "configs/docker/Dockerfile.web"
            ".env.production"
            "scripts/deploy-vps.sh"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ Found: $file"
            else
              echo "‚ùå Missing: $file"
              exit 1
            fi
          done
          
          echo "‚úÖ Estrutura do projeto validada"

      - name: üèóÔ∏è Install Root Dependencies  
        run: |
          echo "üì¶ Instalando depend√™ncias do monorepo..."
          npm ci --ignore-scripts --no-fund --no-audit
          echo "‚úÖ Depend√™ncias do monorepo instaladas"

      - name: üèóÔ∏è Install Backend Dependencies
        run: |
          echo "üì¶ Instalando depend√™ncias do backend..."
          cd apps/backend
          npm ci --ignore-scripts --no-fund --no-audit
          echo "‚úÖ Depend√™ncias do backend instaladas"

      - name: üîß Generate Prisma Client
        run: |
          echo "üóÉÔ∏è Gerando cliente Prisma..."
          cd apps/backend
          npx prisma generate
          echo "‚úÖ Cliente Prisma gerado"

      - name: üèóÔ∏è Build Backend
        run: |
          echo "üî® Fazendo build do backend..."
          cd apps/backend
          npm run build
          npm run copyfiles
          echo "‚úÖ Build do backend conclu√≠do"

      - name: üèóÔ∏è Install Frontend Dependencies
        run: |
          echo "üì¶ Instalando depend√™ncias do frontend..."
          cd apps/web
          # Complete clean start for Rollup optional dependencies
          rm -rf node_modules package-lock.json 2>/dev/null || true
          # Clear npm cache to avoid corrupted optional dependencies
          npm cache clean --force 2>/dev/null || true
          # Install dependencies with explicit platform support
          PLATFORM=$(node -e "console.log(process.platform)")
          ARCH=$(node -e "console.log(process.arch)")
          echo "Detecting platform: $PLATFORM-$ARCH"
          
          # Install base dependencies first
          npm install --no-fund --no-audit --prefer-dedupe
          
          # Force install Rollup platform-specific binary
          if [ "$PLATFORM" = "linux" ] && [ "$ARCH" = "x64" ]; then
            echo "Installing Linux x64 specific Rollup binary..."
            npm install @rollup/rollup-linux-x64-gnu --save-optional --no-fund --no-audit || {
              echo "Direct install failed, trying with legacy peer deps..."
              npm install @rollup/rollup-linux-x64-gnu --save-optional --legacy-peer-deps --no-fund --no-audit || true
            }
          fi
          
          # Rebuild native modules to ensure binaries are linked correctly
          npm rebuild --no-fund --no-audit || true
          
          # Verify Rollup installation
          echo "Verifying Rollup installation..."
          npx rollup --version || {
            echo "Rollup verification failed, forcing complete reinstall..."
            rm -rf node_modules
            npm install --no-fund --no-audit
            npm install @rollup/rollup-linux-x64-gnu --save-optional --force || true
          }
          
          echo "‚úÖ Depend√™ncias do frontend instaladas com suporte completo Rollup"

      - name: üèóÔ∏è Build Frontend
        run: |
          echo "üî® Fazendo build do frontend..."
          cd apps/web
          
          # Final verification before build
          echo "Verificando depend√™ncias cr√≠ticas antes do build..."
          node -e "
            try {
              const rollup = require('rollup');
              console.log('‚úÖ Rollup core module encontrado');
            } catch (e) {
              console.error('‚ùå Rollup core module n√£o encontrado:', e.message);
              process.exit(1);
            }
          " || {
            echo "‚ùå Rollup n√£o encontrado, tentando instala√ß√£o de emerg√™ncia..."
            npm install rollup vite --force --no-fund --no-audit
            npm install @rollup/rollup-linux-x64-gnu --save-optional --force --no-fund --no-audit || true
          }
          
          # Execute build with error handling
          npm run build || {
            echo "‚ùå Build falhou, tentando diagn√≥stico..."
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "Platform: $(node -e 'console.log(process.platform + \"-\" + process.arch)')"
            echo ""
            echo "Rollup modules installed:"
            find node_modules -name "*rollup*" -type d | head -10 || echo "Nenhum m√≥dulo Rollup encontrado"
            echo ""
            echo "Tentando build com verbose..."
            npm run build --verbose || exit 1
          }
          
          echo "‚úÖ Build do frontend conclu√≠do"

      - name: üß™ Validate TypeScript (Backend)
        run: |
          echo "üîç Validando TypeScript do backend..."
          cd apps/backend
          npx tsc --noEmit
          echo "‚úÖ TypeScript do backend validado"

      - name: üß™ Validate TypeScript (Frontend)
        run: |
          echo "üîç Validando TypeScript do frontend..."
          cd apps/web
          npm run typecheck
          echo "‚úÖ TypeScript do frontend validado"

  # ====================================
  # JOB 2: DEPLOY NA VPS
  # ====================================
  deploy:
    name: üöÄ Deploy to VPS
    runs-on: ubuntu-latest
    needs: validate-and-build
    
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üöÄ Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          timeout: 900s
          command_timeout: 900s
          script: |
            # Fun√ß√£o de log com timestamp
            log() {
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
            }
            
            # Configura√ß√µes
            APP_DIR="${{ env.APP_DIR }}"
            REPO_URL="https://github.com/${{ github.repository }}.git"
            COMPOSE_PROJECT_NAME="${{ env.COMPOSE_PROJECT_NAME }}"
            
            # ====================================
            # ETAPA 1: PREPARAR AMBIENTE
            # ====================================
            log "üöÄ INICIANDO DEPLOY SOCIAL B√çBLIA"
            log "Backend: Vincent Queimado Express + Prisma + TypeScript"
            log "Database: PostgreSQL"
            log "Frontend: React + Vite"
            
            # Criar diret√≥rio da aplica√ß√£o
            mkdir -p $APP_DIR
            cd $APP_DIR
            
            # Parar containers existentes
            log "‚èπÔ∏è Parando containers existentes..."
            docker compose -f docker-compose.new.yml down --remove-orphans 2>/dev/null || true
            
            # ====================================
            # ETAPA 2: ATUALIZAR C√ìDIGO
            # ====================================
            log "üì• Atualizando c√≥digo fonte..."
            
            if [ ! -d ".git" ]; then
              log "üì• Clonando reposit√≥rio..."
              git clone $REPO_URL . || {
                log "‚ùå Clone falhou, usando download direto..."
                curl -L https://github.com/${{ github.repository }}/archive/main.tar.gz | tar xz --strip-components=1
              }
            else
              log "üîÑ Atualizando reposit√≥rio existente..."
              git fetch origin && git reset --hard origin/main && git clean -fd
            fi
            
            # Verificar se arquivos essenciais existem
            REQUIRED_FILES="docker-compose.new.yml apps/backend/package.json apps/web/package.json configs/docker/Dockerfile.backend configs/docker/Dockerfile.web"
            for file in $REQUIRED_FILES; do
              if [ ! -f "$file" ]; then
                log "‚ùå Arquivo obrigat√≥rio n√£o encontrado: $file"
                ls -la $(dirname "$file")/
                exit 1
              fi
            done
            
            log "‚úÖ C√≥digo fonte atualizado com sucesso"
            
            # ====================================
            # ETAPA 3: INSTALAR DEPEND√äNCIAS DO SISTEMA
            # ====================================
            log "üîß Verificando depend√™ncias do sistema..."
            
            # Atualizar lista de pacotes
            apt-get update -qq
            
            # Instalar Docker se necess√°rio
            if ! command -v docker >/dev/null 2>&1; then
              log "üì¶ Instalando Docker..."
              curl -fsSL https://get.docker.com | sh
              systemctl start docker
              systemctl enable docker
              log "‚úÖ Docker instalado"
            else
              log "‚úÖ Docker j√° instalado ($(docker --version))"
            fi
            
            # Verificar Docker Compose
            if ! docker compose version >/dev/null 2>&1; then
              log "üì¶ Instalando Docker Compose..."
              apt-get install -y docker-compose-plugin
              log "‚úÖ Docker Compose instalado"
            else
              log "‚úÖ Docker Compose j√° instalado ($(docker compose version))"
            fi
            
            # Verificar se Docker est√° funcionando
            if ! docker info >/dev/null 2>&1; then
              log "‚ùå Docker n√£o est√° funcionando corretamente"
              systemctl restart docker
              sleep 10
              if ! docker info >/dev/null 2>&1; then
                log "‚ùå Falha cr√≠tica: Docker n√£o est√° funcionando"
                exit 1
              fi
            fi
            
            log "‚úÖ Todas as depend√™ncias do sistema verificadas"
            
            # ====================================
            # ETAPA 4: CONFIGURAR VARI√ÅVEIS DE AMBIENTE
            # ====================================
            log "üìù Configurando vari√°veis de ambiente..."
            
            # Copiar arquivo de produ√ß√£o se n√£o existir
            if [ ! -f ".env" ]; then
              if [ -f ".env.production" ]; then
                log "üìã Usando .env.production existente"
                cp .env.production .env
              else
                log "üìù Criando arquivo .env de produ√ß√£o..."
                cat > .env << 'EOF'
            # ==============================================
            # CONFIGURA√á√ïES DE PRODU√á√ÉO - SOCIAL B√çBLIA
            # Backend: Vincent Queimado Express + Prisma + TypeScript
            # ==============================================
            
            # Database Configuration (PostgreSQL)
            POSTGRES_DB=socialbiblia_db
            POSTGRES_USER=socialbiblia_user
            POSTGRES_PASSWORD=SocialBiblia@2024#SecureDB!VPS
            POSTGRES_PORT=5432
            DATABASE_URL=postgresql://socialbiblia_user:SocialBiblia@2024#SecureDB!VPS@postgres:5432/socialbiblia_db?schema=public
            
            # API Configuration (Vincent Queimado Backend)
            APP_URL_HOST=0.0.0.0
            APP_URL_PORT=3344
            SSL_ALLOW=false
            API_PREFIX=api
            API_JSON_LIMIT=5mb
            API_EXT_URLENCODED=false
            CORS_ALLOW_ORIGIN=*
            
            # JWT Configuration (Vincent Queimado Format)
            JWT_SECRET_USER=SocialBiblia@VincentQueimado#UserJWT2024!VPS#Secure
            JWT_SECRET_DEVICE=SocialBiblia@VincentQueimado#DeviceJWT2024!VPS#Secure
            JWT_EXPIRED_IN=24h
            
            # Security Configuration
            BCRYPT_SALTROUNDS=12
            RATE_LIMIT_MAX=500
            RATE_LIMIT_WINDOW=15
            
            # Debug Configuration (DISABLED IN PRODUCTION)
            DEBUG_HTTP_REQUEST=false
            DEBUG_HTTP_CONNECTION=false
            
            # Service Ports
            API_PORT=3344
            WEB_PORT=3000
            PGLADMIN_PORT=8080
            
            # pgAdmin Configuration
            PGLADMIN_DEFAULT_EMAIL=admin@socialbiblia.com
            PGLADMIN_DEFAULT_PASSWORD=SocialBiblia@Admin2024!VPS
            
            # Email Configuration (Optional)
            EMAIL_USER=admin@socialbiblia.com
            EMAIL_PASSWORD=
            EMAIL_SERVICE=gmail
            EMAIL_OAUTH_CLIENT_ID=
            EMAIL_OAUTH_CLIENT_SECRET=
            EMAIL_OAUTH_REFRESH_TOKEN=
            
            # Production Environment
            NODE_ENV=production
            TZ=America/Sao_Paulo
            COMPOSE_PROFILES=production
            EOF
              fi
            fi
            
            log "‚úÖ Vari√°veis de ambiente configuradas"
            
            # ====================================
            # ETAPA 5: DIAGN√ìSTICO DO SISTEMA
            # ====================================
            log "üîç Diagn√≥stico do sistema..."
            
            log "üíæ Recursos dispon√≠veis:"
            echo "  Memory: $(free -h | grep '^Mem:' | awk '{print $3"/"$2" ("$5")"}')"
            echo "  Disk: $(df -h / | tail -1 | awk '{print $3"/"$2" ("$5" used)"}')"
            echo "  Load: $(uptime | sed 's/.*load average: //')"
            
            log "üê≥ Docker Status:"
            docker --version
            docker compose version
            docker system df
            
            log "üì¶ Containers existentes:"
            docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | head -10
            
            log "üîå Portas em uso:"
            netstat -tulpn | grep -E ':(3000|3344|5432|8080) ' | head -5 || echo "  Portas principais livres"
            
            # ====================================
            # ETAPA 6: LIMPEZA PRE-BUILD
            # ====================================
            log "üßπ Limpando ambiente..."
            
            # Parar containers do projeto
            docker compose -f docker-compose.new.yml down --remove-orphans 2>/dev/null || true
            
            # Limpar apenas imagens do projeto
            docker images --format "table {{.Repository}}:{{.Tag}}" | grep -E "(socialbiblia|backend|web)" | awk '{print $1}' | xargs -r docker rmi -f 2>/dev/null || true
            
            # Limpar volumes √≥rf√£os do projeto
            docker volume ls --format "{{.Name}}" | grep "socialbiblia" | xargs -r docker volume rm 2>/dev/null || true
            
            log "‚úÖ Ambiente limpo"
            
            # ====================================
            # ETAPA 7: BUILD E DEPLOY
            # ====================================
            log "üî® Iniciando build e deploy..."
            
            # Build das imagens
            log "üèóÔ∏è Fazendo build das imagens..."
            if ! docker compose -f docker-compose.new.yml build --no-cache --parallel; then
              log "‚ùå Falha no build das imagens!"
              docker system df
              exit 1
            fi
            
            log "‚úÖ Build das imagens conclu√≠do"
            
            # Iniciar servi√ßos
            log "üöÄ Iniciando servi√ßos..."
            if ! docker compose -f docker-compose.new.yml up -d; then
              log "‚ùå Falha ao iniciar servi√ßos!"
              docker compose -f docker-compose.new.yml logs
              exit 1
            fi
            
            log "‚úÖ Servi√ßos iniciados"
            
            # ====================================
            # ETAPA 8: AGUARDAR INICIALIZA√á√ÉO
            # ====================================
            log "‚è≥ Aguardando inicializa√ß√£o dos servi√ßos..."
            
            # Aguardar PostgreSQL
            log "üêò Aguardando PostgreSQL..."
            timeout=120
            while [ $timeout -gt 0 ]; do
              if docker compose -f docker-compose.new.yml exec -T postgres pg_isready -U socialbiblia_user -d socialbiblia_db >/dev/null 2>&1; then
                log "‚úÖ PostgreSQL pronto!"
                break
              fi
              sleep 2
              timeout=$((timeout - 2))
              if [ $((timeout % 20)) -eq 0 ]; then
                log "‚è≥ Aguardando PostgreSQL... ($timeout segundos restantes)"
              fi
            done
            
            if [ $timeout -le 0 ]; then
              log "‚ùå Timeout aguardando PostgreSQL"
              docker compose -f docker-compose.new.yml logs postgres
              exit 1
            fi
            
            # Executar migra√ß√µes do Prisma
            log "üóÉÔ∏è Executando migra√ß√µes do banco..."
            if ! docker compose -f docker-compose.new.yml exec -T api npx prisma migrate deploy; then
              log "‚ö†Ô∏è Migra√ß√µes falharam, tentando reset..."
              docker compose -f docker-compose.new.yml exec -T api npx prisma migrate reset --force
              docker compose -f docker-compose.new.yml exec -T api npx prisma migrate deploy
            fi
            
            # Executar seed (opcional)
            log "üå± Executando seed do banco..."
            docker compose -f docker-compose.new.yml exec -T api npm run prisma:seed || log "‚ö†Ô∏è Seed falhou ou j√° executado"
            
            # Aguardar API
            log "üîå Aguardando API..."
            timeout=120
            while [ $timeout -gt 0 ]; do
              if curl -f http://localhost:3344/api/info >/dev/null 2>&1; then
                log "‚úÖ API pronta!"
                break
              fi
              sleep 2
              timeout=$((timeout - 2))
              if [ $((timeout % 20)) -eq 0 ]; then
                log "‚è≥ Aguardando API... ($timeout segundos restantes)"
              fi
            done
            
            if [ $timeout -le 0 ]; then
              log "‚ùå Timeout aguardando API"
              docker compose -f docker-compose.new.yml logs api
              exit 1
            fi
            
            # Aguardar Frontend
            log "üåê Aguardando Frontend..."
            timeout=60
            while [ $timeout -gt 0 ]; do
              if curl -f http://localhost:3000 >/dev/null 2>&1; then
                log "‚úÖ Frontend pronto!"
                break
              fi
              sleep 2
              timeout=$((timeout - 2))
              if [ $((timeout % 10)) -eq 0 ]; then
                log "‚è≥ Aguardando Frontend... ($timeout segundos restantes)"
              fi
            done
            
            if [ $timeout -le 0 ]; then
              log "‚ùå Timeout aguardando Frontend"
              docker compose -f docker-compose.new.yml logs web
              exit 1
            fi
            
            # ====================================
            # ETAPA 9: VERIFICA√á√ïES FINAIS
            # ====================================
            log "üîç Executando verifica√ß√µes finais..."
            
            # Status dos containers
            log "üìä Status dos containers:"
            docker compose -f docker-compose.new.yml ps
            
            # Health checks
            HEALTH_ISSUES=""
            
            # Test API endpoints
            if curl -f http://localhost:3344/api/info >/dev/null 2>&1; then
              log "‚úÖ API Health Check: OK"
            else
              log "‚ùå API Health Check: FALHOU"
              HEALTH_ISSUES="api "
            fi
            
            # Test Frontend
            if curl -f http://localhost:3000 >/dev/null 2>&1; then
              log "‚úÖ Frontend Health Check: OK"
            else
              log "‚ùå Frontend Health Check: FALHOU"
              HEALTH_ISSUES="frontend "
            fi
            
            # Test pgAdmin
            if curl -f http://localhost:8080 >/dev/null 2>&1; then
              log "‚úÖ pgAdmin Health Check: OK"
            else
              log "‚ö†Ô∏è pgAdmin Health Check: Pode estar inicializando"
            fi
            
            # Verificar se containers est√£o rodando
            EXPECTED_CONTAINERS="socialbiblia_postgres socialbiblia_api socialbiblia_web"
            for container in $EXPECTED_CONTAINERS; do
              if docker ps --format "{{.Names}}" | grep -q "$container"; then
                log "‚úÖ Container $container: Rodando"
              else
                log "‚ùå Container $container: N√ÉO est√° rodando"
                HEALTH_ISSUES="$container "
              fi
            done
            
            # ====================================
            # ETAPA 10: RESULTADO FINAL
            # ====================================
            if [ -n "$HEALTH_ISSUES" ]; then
              log "‚ùå DEPLOY CONCLU√çDO COM PROBLEMAS!"
              log "üîç Servi√ßos com problemas: $HEALTH_ISSUES"
              log "üìã Logs dos containers:"
              docker compose -f docker-compose.new.yml logs --tail=50
              exit 1
            else
              log "üéâ DEPLOY DA SOCIAL B√çBLIA CONCLU√çDO COM SUCESSO!"
              log ""
              log "üåê APLICA√á√ÉO DISPON√çVEL EM:"
              log "   ‚úÖ Frontend (React):     http://${{ env.VPS_HOST }}:3000"
              log "   ‚úÖ API (Vincent Q.):     http://${{ env.VPS_HOST }}:3344/api/"
              log "   ‚úÖ API Docs (Swagger):  http://${{ env.VPS_HOST }}:3344/api/docs"
              log "   ‚úÖ pgAdmin:             http://${{ env.VPS_HOST }}:8080"
              log ""
              log "üîß TECNOLOGIAS DEPLOYADAS:"
              log "   ‚Ä¢ Backend: Vincent Queimado Express + Prisma + TypeScript"
              log "   ‚Ä¢ Database: PostgreSQL 15"
              log "   ‚Ä¢ Frontend: React 18 + Vite"
              log "   ‚Ä¢ Container: Docker + Docker Compose"
              log ""
              log "üìä RESUMO:"
              log "   ‚Ä¢ Containers ativos: $(docker ps --format '{{.Names}}' | grep socialbiblia | wc -l)"
              log "   ‚Ä¢ Volumes: $(docker volume ls --format '{{.Name}}' | grep socialbiblia | wc -l)"
              log "   ‚Ä¢ Networks: $(docker network ls --format '{{.Name}}' | grep socialbiblia | wc -l)"
              log ""
              log "üíæ USO DE RECURSOS:"
              docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" | head -5
              log ""
              log "üöÄ DEPLOY FINALIZADO - APLICA√á√ÉO PRONTA PARA USO!"
            fi

  # ====================================
  # JOB 3: NOTIFICA√á√ÉO (OPCIONAL)
  # ====================================
  notify:
    name: üì¢ Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: üì¢ Deploy Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deploy realizado com sucesso!"
            echo "üåê Social B√≠blia dispon√≠vel em: http://${{ env.VPS_HOST }}:3000"
          else
            echo "‚ùå Deploy falhou!"
            exit 1
          fi