name: ğŸš€ Deploy Incremental SocialBiblia

# Controle de concorrÃªncia - ÃšNICO deploy por vez
concurrency:
  group: socialbiblia-production-deploy
  cancel-in-progress: true

on:
  push:
    branches: [main]
    paths:
      - 'apps/web/src/**'
      - 'apps/web/package*.json'
      - 'package*.json'
      - 'supabase/**'
      - '.github/workflows/deploy-incremental.yml'
  workflow_dispatch:

env:
  VPS_HOST: '31.97.85.98'
  VPS_USER: 'root'
  APP_DIR: '/root/socialbiblia'
  COMPOSE_PROJECT_NAME: 'supabase'

jobs:
  analyze-changes:
    name: ğŸ” Analisar MudanÃ§as
    runs-on: ubuntu-latest
    outputs:
      has_code_changes: ${{ steps.changes.outputs.has_code_changes }}
      has_package_changes: ${{ steps.changes.outputs.has_package_changes }}
      has_config_changes: ${{ steps.changes.outputs.has_config_changes }}
      needs_restart: ${{ steps.changes.outputs.needs_restart }}
      deploy_type: ${{ steps.changes.outputs.deploy_type }}
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: ğŸ” Analisar arquivos alterados
      id: changes
      run: |
        echo "ğŸ” Analisando mudanÃ§as desde o Ãºltimo commit..."
        
        # Obter arquivos alterados
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "all")
        echo "ğŸ“ Arquivos alterados:"
        echo "$CHANGED_FILES"
        
        # Inicializar flags
        HAS_CODE=false
        HAS_PACKAGE=false
        HAS_CONFIG=false
        NEEDS_RESTART=false
        
        # Analisar tipos de mudanÃ§as para SocialBiblia + Supabase
        if echo "$CHANGED_FILES" | grep -E "(apps/web/src/.*\.(js|ts|tsx|json))" > /dev/null; then
          HAS_CODE=true
          echo "âœ… MudanÃ§as de cÃ³digo frontend detectadas"
        fi
        
        if echo "$CHANGED_FILES" | grep -E "package(-lock)?\.json" > /dev/null; then
          HAS_PACKAGE=true
          echo "ğŸ“¦ MudanÃ§as em dependÃªncias detectadas"
        fi
        
        if echo "$CHANGED_FILES" | grep -E "(supabase/.*\.(yml|env|sql)|docker)" > /dev/null; then
          HAS_CONFIG=true
          echo "âš™ï¸ MudanÃ§as de configuraÃ§Ã£o Supabase detectadas"
        fi
        
        # Determinar se precisa restart
        if [[ "$HAS_CODE" == "true" || "$HAS_CONFIG" == "true" ]]; then
          NEEDS_RESTART=true
        fi
        
        # Determinar tipo de deploy
        if [[ "$HAS_PACKAGE" == "true" ]]; then
          DEPLOY_TYPE="full"
          echo "ğŸ”„ Deploy completo necessÃ¡rio (dependÃªncias mudaram)"
        elif [[ "$HAS_CODE" == "true" ]]; then
          DEPLOY_TYPE="code-only"
          echo "ğŸ“ Deploy apenas de cÃ³digo"
        elif [[ "$HAS_CONFIG" == "true" ]]; then
          DEPLOY_TYPE="config-only"
          echo "âš™ï¸ Deploy apenas de configuraÃ§Ã£o"
        else
          DEPLOY_TYPE="minimal"
          echo "ğŸ“‹ Deploy mÃ­nimo (docs/workflows)"
        fi
        
        # Definir outputs
        echo "has_code_changes=$HAS_CODE" >> $GITHUB_OUTPUT
        echo "has_package_changes=$HAS_PACKAGE" >> $GITHUB_OUTPUT
        echo "has_config_changes=$HAS_CONFIG" >> $GITHUB_OUTPUT
        echo "needs_restart=$NEEDS_RESTART" >> $GITHUB_OUTPUT
        echo "deploy_type=$DEPLOY_TYPE" >> $GITHUB_OUTPUT

  deploy:
    name: ğŸš€ Deploy Incremental
    runs-on: ubuntu-latest
    needs: analyze-changes
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“‹ Info do Deploy Incremental
      run: |
        echo "ğŸš€ Deploy Incremental SocialBiblia"
        echo "=============================================="
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Tipo de Deploy: ${{ needs.analyze-changes.outputs.deploy_type }}"
        echo "MudanÃ§as de CÃ³digo: ${{ needs.analyze-changes.outputs.has_code_changes }}"
        echo "MudanÃ§as de DependÃªncias: ${{ needs.analyze-changes.outputs.has_package_changes }}"
        echo "Precisa Restart: ${{ needs.analyze-changes.outputs.needs_restart }}"
        echo "=============================================="

    - name: ğŸ”‘ Configurar SSH
      run: |
        echo "ğŸ”‘ Configurando SSH para deploy incremental..."
        sudo apt-get update && sudo apt-get install -y sshpass
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts
        echo "âœ… SSH configurado"

    - name: ğŸ” Verificar estado atual da VPS
      run: |
        echo "ğŸ” Verificando estado atual..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          echo '=== Estado Atual da VPS ==='
          echo 'Docker version:'
          docker --version || echo 'Docker nÃ£o encontrado'
          
          echo ''
          echo 'Docker Compose version:'
          if command -v 'docker compose' >/dev/null 2>&1; then
            docker compose version
            DOCKER_COMPOSE_CMD='docker compose'
          elif command -v 'docker-compose' >/dev/null 2>&1; then
            docker-compose version
            DOCKER_COMPOSE_CMD='docker-compose'
          else
            echo 'Docker Compose nÃ£o encontrado'
            DOCKER_COMPOSE_CMD='none'
          fi
          
          echo ''
          echo 'Docker Containers:'
          docker ps --format 'table {{.Names}}\t{{.Status}}' | grep ${{ env.COMPOSE_PROJECT_NAME }} || echo 'NÃ£o rodando'
          
          echo ''
          echo 'Docker Compose status:'
          if [ -f ${{ env.APP_DIR }}/docker-compose.yml ] && [ \"\$DOCKER_COMPOSE_CMD\" != 'none' ]; then
            cd ${{ env.APP_DIR }} && \$DOCKER_COMPOSE_CMD ps || echo 'Docker Compose nÃ£o encontrado'
          else
            echo 'ğŸ“‹ Docker Compose nÃ£o configurado'
          fi
          
          echo ''
          echo 'Ãšltima atualizaÃ§Ã£o:'
          cd ${{ env.APP_DIR }} && git log --oneline -1 2>/dev/null || echo 'RepositÃ³rio nÃ£o inicializado'
        "

    - name: ğŸ“¦ Backup Inteligente (somente se necessÃ¡rio)
      if: needs.analyze-changes.outputs.deploy_type == 'full'
      run: |
        echo "ğŸ“¦ Fazendo backup completo (deploy full)..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          TIMESTAMP=\$(date +%Y%m%d_%H%M%S)
          BACKUP_DIR=/opt/socialbiblia-backups/backup_\$TIMESTAMP
          mkdir -p \$BACKUP_DIR
          
          # Backup crÃ­tico - volumes do Docker
          if [ -d ${{ env.APP_DIR }}/data ]; then
            cp -r ${{ env.APP_DIR }}/data \$BACKUP_DIR/
            echo 'âœ… Data volumes backed up'
          fi
          
          # Backup da configuraÃ§Ã£o atual
          if [ -f ${{ env.APP_DIR }}/.env.production ]; then
            cp ${{ env.APP_DIR }}/.env.production \$BACKUP_DIR/
            echo 'âœ… Production env backed up'
          fi
          
          echo \"ğŸ“¦ Backup completo criado: \$BACKUP_DIR\"
        "

    - name: ğŸ“¦ Backup RÃ¡pido (somente dados crÃ­ticos)
      if: needs.analyze-changes.outputs.deploy_type != 'full'
      run: |
        echo "ğŸ“¦ Backup rÃ¡pido (apenas dados crÃ­ticos)..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          if [ -f ${{ env.APP_DIR }}/.env.production ]; then
            cp ${{ env.APP_DIR }}/.env.production /tmp/env_backup.production
            echo 'âœ… Environment preservado'
          fi
          
          # Backup dos volumes do banco se existir
          if [ -d ${{ env.APP_DIR }}/data/postgres ]; then
            tar -czf /tmp/postgres_backup.tar.gz -C ${{ env.APP_DIR }}/data postgres
            echo 'âœ… Postgres data preservado'
          fi
        "

    - name: ğŸ³ Instalar Docker e Docker Compose
      run: |
        echo "ğŸ³ Garantindo Docker e Docker Compose..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          # Criar diretÃ³rio se nÃ£o existir
          mkdir -p ${{ env.APP_DIR }}
          cd ${{ env.APP_DIR }}
          
          # Instalar Docker se nÃ£o estiver instalado
          if ! command -v docker >/dev/null 2>&1; then
            echo 'ğŸ“¦ Instalando Docker...'
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            systemctl enable docker
            systemctl start docker
            echo 'âœ… Docker instalado'
          else
            echo 'âœ… Docker jÃ¡ instalado'
            docker --version
          fi
          
          # Instalar Docker Compose standalone se nÃ£o estiver disponÃ­vel
          if ! command -v 'docker compose' >/dev/null 2>&1 && ! command -v 'docker-compose' >/dev/null 2>&1; then
            echo 'ğŸ“¦ Instalando Docker Compose standalone...'
            COMPOSE_VERSION=\$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d'\"' -f4)
            curl -L \"https://github.com/docker/compose/releases/download/\${COMPOSE_VERSION}/docker-compose-\$(uname -s)-\$(uname -m)\" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
            echo 'âœ… Docker Compose standalone instalado'
            docker-compose --version
          else
            echo 'âœ… Docker Compose jÃ¡ disponÃ­vel'
            if command -v 'docker compose' >/dev/null 2>&1; then
              docker compose version
            else
              docker-compose --version
            fi
          fi
        "

    - name: ğŸš€ Deploy usando Script de ProduÃ§Ã£o
      run: |
        echo "ğŸš€ Executando deploy com script de produÃ§Ã£o..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          # Garantir que o diretÃ³rio existe
          mkdir -p ${{ env.APP_DIR }}
          cd ${{ env.APP_DIR }}
          
          # Clonar ou atualizar o repositÃ³rio primeiro
          if [ ! -d .git ]; then
            echo 'ğŸ†• Clonando repositÃ³rio...'
            git clone https://github.com/${{ github.repository }}.git .
          else
            echo 'ğŸ“¥ Atualizando repositÃ³rio...'
            git fetch origin
            git reset --hard origin/main
          fi
          
          # Deploy SocialBiblia + Supabase
          echo 'ğŸš€ Executando deploy SocialBiblia + Supabase...'
          
          # Build do frontend primeiro
          echo 'ğŸ“¦ Building frontend...'
          cd apps/web
          npm ci --only=production
          npm run build
          
          # Deploy do frontend no nginx
          echo 'ğŸš€ Deploying frontend to nginx...'
          docker rm -f nginx-socialbiblia 2>/dev/null || true
          docker run -d --name nginx-socialbiblia -p 3000:80 -v "$(pwd)/dist:/usr/share/nginx/html:ro" nginx:alpine
          echo 'âœ… Frontend deployed to nginx'
          
          cd ../..
          
          # Navegar para Supabase
          cd supabase
          
          # Detectar comando Docker Compose
          if command -v 'docker compose' >/dev/null 2>&1; then
            DOCKER_COMPOSE_CMD='docker compose'
          elif command -v 'docker-compose' >/dev/null 2>&1; then
            DOCKER_COMPOSE_CMD='docker-compose'
          else
            echo 'âŒ Docker Compose nÃ£o encontrado!'
            exit 1
          fi
          
          # Verificar se docker-compose.yml existe
          if [ ! -f docker-compose.yml ]; then
            echo 'âŒ docker-compose.yml nÃ£o encontrado em supabase/!'
            echo 'ğŸ“ Arquivos no diretÃ³rio supabase:'
            ls -la
            exit 1
          fi
          
          # Parar containers existentes
          echo 'ğŸ”„ Parando containers existentes...'
          \$DOCKER_COMPOSE_CMD down || true
          
          # Limpar imagens antigas se necessÃ¡rio
          if [[ '${{ needs.analyze-changes.outputs.has_package_changes }}' == 'true' ]]; then
            echo 'ğŸ§¹ Limpando imagens antigas (dependÃªncias mudaram)...'
            \$DOCKER_COMPOSE_CMD down --rmi all || true
          fi
          
          # Iniciar aplicaÃ§Ã£o
          echo 'ğŸš€ Iniciando aplicaÃ§Ã£o...'
          \$DOCKER_COMPOSE_CMD up -d --build
          
          # Aguardar inicializaÃ§Ã£o
          echo 'â³ Aguardando inicializaÃ§Ã£o...'
          sleep 60
          
          echo 'âœ… Deploy concluÃ­do'
        "


    - name: ğŸ” VerificaÃ§Ã£o RÃ¡pida
      run: |
        echo "ğŸ” VerificaÃ§Ã£o final..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.APP_DIR }}/supabase
          
          # Detectar comando Docker Compose
          if command -v 'docker compose' >/dev/null 2>&1; then
            DOCKER_COMPOSE_CMD='docker compose'
          elif command -v 'docker-compose' >/dev/null 2>&1; then
            DOCKER_COMPOSE_CMD='docker-compose'
          else
            echo 'âŒ Docker Compose nÃ£o encontrado!'
            exit 1
          fi
          
          # Verificar Docker containers
          echo 'ğŸ” Status dos containers:'
          \$DOCKER_COMPOSE_CMD ps || echo 'Erro ao verificar containers'
          
          if \$DOCKER_COMPOSE_CMD ps | grep -q 'Up'; then
            echo 'âœ… Docker containers rodando'
          else
            echo 'âš ï¸ Containers podem estar iniciando ainda...'
            echo 'ğŸ” Aguardando mais 30s...'
            sleep 30
            \$DOCKER_COMPOSE_CMD ps
            if \$DOCKER_COMPOSE_CMD ps | grep -q 'Up'; then
              echo 'âœ… Containers funcionando apÃ³s aguardar'
            else
              echo 'âŒ Containers ainda nÃ£o estÃ£o funcionando - verificar logs'
              \$DOCKER_COMPOSE_CMD logs --tail 20
              exit 1
            fi
          fi
          
          # Verificar health check rÃ¡pido
          for i in {1..3}; do
            if curl -f -s http://localhost:3001/health >/dev/null 2>&1; then
              echo 'âœ… Health check OK'
              break
            else
              echo \"â³ Tentativa \$i/3...\"
              sleep 5
            fi
            
            if [ \$i -eq 3 ]; then
              echo 'âš ï¸ Health check demorou, mas containers estÃ£o rodando'
            fi
          done
        "

    - name: ğŸ“Š RelatÃ³rio do Deploy Incremental
      if: always()
      run: |
        echo "ğŸ“Š RELATÃ“RIO DO DEPLOY INCREMENTAL"
        echo "=================================="
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          echo 'Tipo de Deploy: ${{ needs.analyze-changes.outputs.deploy_type }}'
          echo 'Restart Executado: ${{ needs.analyze-changes.outputs.needs_restart }}'
          echo 'DependÃªncias Atualizadas: ${{ needs.analyze-changes.outputs.has_package_changes }}'
          echo ''
          
          echo '=== Status da AplicaÃ§Ã£o Supabase ==='
          cd ${{ env.APP_DIR }}/supabase
          
          # Detectar comando Docker Compose
          if command -v 'docker compose' >/dev/null 2>&1; then
            docker compose ps --no-trunc || echo 'Docker Compose nÃ£o encontrado'
          elif command -v 'docker-compose' >/dev/null 2>&1; then
            docker-compose ps --no-trunc || echo 'Docker Compose nÃ£o encontrado'
          else
            echo 'Docker Compose nÃ£o encontrado!'
          fi
          
          echo ''
          echo '=== Volumes Supabase Preservados ==='
          docker volume ls | grep socialbiblia || echo 'Nenhum volume encontrado'
          
          echo ''
          echo '=== Ãšltimo Commit ==='
          cd ${{ env.APP_DIR }} && git log --oneline -1
          
          echo ''
          echo 'ğŸ¯ Frontend: http://${{ env.VPS_HOST }}:3000'
          echo 'ğŸ¯ Supabase API: http://${{ env.VPS_HOST }}:3001'
          echo 'ğŸ¯ PostgreSQL: http://${{ env.VPS_HOST }}:5433'
          echo 'âš¡ Deploy incremental Supabase concluÃ­do!'
        "

    - name: ğŸ‰ Deploy Incremental ConcluÃ­do
      run: |
        echo "ğŸ‰ DEPLOY INCREMENTAL SUPABASE REALIZADO COM SUCESSO!"
        echo "âš¡ Tipo: ${{ needs.analyze-changes.outputs.deploy_type }}"
        echo "ğŸ›¡ï¸ Dados preservados: SIM"
        echo "ğŸš€ Frontend: http://${{ env.VPS_HOST }}:3000"
        echo "ğŸš€ Supabase API: http://${{ env.VPS_HOST }}:3001"